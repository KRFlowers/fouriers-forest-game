<!-- 
    Cicada Smash Game
    Created by Kristi Loesch
    
    Credits:
    - Forest image by Gustavo Rezende from Pixabay
    - Cicada sound effect from https://notification-sounds.com/584-cicada-sound-effect.html
    - Bug animation library by Auz (https://github.com/Auz/Bug)
-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cicada Smash Game</title>
    
	<link href="css/game.css" rel="stylesheet" />



<style>
.custom-modal {
    display: none;
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.85);
    z-index: 1000;
}

.modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #f8f8f8;
    padding: 20px;
    border: 1px solid #e0e0e0;
    width: 400px;
    max-width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    border-radius: 10px;
}

.modal-content h2 {
    color: #228B22;
    margin-top: 0;
    font-size: 22px;
}

.modal-content h3 {
    color: #333;
    margin-top: 15px;
    margin-bottom: 8px;
    font-size: 16px;
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin: 15px 0;
    text-align: left;
}

.stat-item {
    background: white;
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #ddd;
}

.stat-label {
    display: block;
    font-size: 11px;
    color: #666;
    margin-bottom: 4px;
}

.stat-value {
    display: block;
    font-size: 16px;
    font-weight: bold;
    color: #228B22;
}

.history-list {
    max-height: 150px;
    overflow-y: auto;
    margin-top: 8px;
}

.history-item {
    background: white;
    padding: 8px;
    margin-bottom: 6px;
    border-radius: 5px;
    border: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
}

.history-date {
    color: #666;
    font-weight: bold;
}

.history-score {
    color: #228B22;
}

.history-accuracy {
    color: #555;
}

.close-button {
    margin-top: 15px;
    margin-right: 10px;
    padding: 10px 25px;
    background-color: #228B22;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
}

.close-button:hover {
    background-color: #1a6b1a;
}

.exit-button {
    margin-top: 15px;
    padding: 10px 25px;
    background-color: #666;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
}

.exit-button:hover {
    background-color: #555;
}

</style>




    <link rel="icon" type="image/x-icon" href="img/favicon.ico" />

    <script type="text/javascript" src="js/jquery-3.6.0.min.js"></script>
    
    <script type="text/javascript" src="Auz-Bug-8eac7b7/bug-min.js"></script> 
    <script>
        var userScore = 0;
        var gameClock;
        var addClock;
        var hideClock;
        var imageCount = 0;
        var imageArray = [];
        var secRemaining = 30;
        
        // Statistical tracking variables
        var totalClicks = 0;
        var successfulClicks = 0;
        var missedClicks = 0;
        var clickTimes = [];
        var gameStartTime = 0;
        var cicadasSpawned = 0;
        var cicadasMissed = 0;

        $(document).ready(
            function(){
                $(".timer").show();
                new BugController({'minBugs':100, 'maxBugs':300});

                $("#start_button").on("click",
                    function () {
                        startGame();
                });

                $("#start_button").css({"width": "100px",
                                        "height": "40px", 
                                        "font-size": "18px",
                                        "font-weight": "bold",
                                        "color": "#228B22",
                                        "border-color": "yellow"});

                $( function() {
                    $("#start_button").tooltip();
                    $(".timer").tooltip();
                    $(".score").tooltip();
                });

            });

        function randomNumberx(){
            return Math.floor((Math.random()*543));     
        }           
     
        function randomNumbery(){
            return Math.floor((Math.random()*280));
        }

        function randomNumberImage(){
            return Math.floor((Math.random()*800));
        }

        function updateScore(){
            userScore += 1;
            successfulClicks++;
            var clickTime = Date.now() - gameStartTime;
            clickTimes.push(clickTime);
            $(".score").html(userScore + " pts");            
        }
       
        function startGame(){
            // When user presses start, initialize all gamespace elements and start game
            secRemaining = 30;
            userScore = 0;
            
            // Reset statistics
            totalClicks = 0;
            successfulClicks = 0;
            missedClicks = 0;
            clickTimes = [];
            cicadasSpawned = 0;
            cicadasMissed = 0;
            gameStartTime = Date.now();
            
            window.location = "#gamespace";
            imageCount = 0;
            imageArray = [];
            $('#playSounds')[0].play();
            $("#start_button").off("click");
            $(".timer").html(secRemaining + " sec left");
            $(".score").html(userScore + " pts"); 
            $("#gamespace img").remove();                   //remove any previous gamespace images
            
            // Track clicks on cicadas
            $("#gamespace").on("click", "img",
                    function() {
                        totalClicks++;
                        updateScore();
                        $(this).remove();
                    });
            
            // Track missed clicks (clicking on empty space)
            $("#gamespace").on("click", function(e) {
                if (e.target.id === "gamespace") {
                    totalClicks++;
                    missedClicks++;
                }
            });

            updateTimer();                                  //start the timer
              }  
            
        function updateTimer(){                
            if (secRemaining < 0) {
                // When time runs out, do the following steps to reset game parameters
                $('#playSounds')[0].pause();               //Pause sound
                $('#playSounds')[0].currentTime =  0;      //set sound back to beginning
                clearTimeout(addClock);                    // Stop image append clock
                clearTimeout(gameClock);                   // Stop game clock    
                $(".score").html(userScore + " pts");
                
                // Calculate and display statistics
                displayGameStats();
                $("#gameOverDialog").show();
                
                $("#gamespace").off("click");              // Turn off gamespace click
                $("#start_button").on("click",
                    function () {
                        startGame();
                });
            }  
            else{ 
                //While time is remaining, do the following to play the game
                addClock = randomNumberImage();
                hideClock = randomNumberImage();
                addClock = setTimeout("addImage()", addClock);      //add image at random interval
                hideClock = setTimeout("hideImage()", hideClock);   //hide images at random interval
                $(".timer").html(secRemaining + " sec left");       //display seconds left            
                secRemaining -= 1;  
                gameClock = setTimeout("updateTimer()", 1000);
               
                 }                    
            }
        function addImage(){
            // Add image to page, each image will have a unique ID provided by the imageCount variable
            var xPos = randomNumberx();
            var yPos = randomNumbery(); 
            var imageID = imageCount + "image";
            $("#gamespace").append(`<img class="gameimage" id="${imageID}" src="img/gameimage.png" style="left: ${xPos}px; top: ${yPos}px;"/>`);
            setTimeout(`updateArray("${imageID}")`, 1000);          // update image array with new image after it has been on the screen for 1 sec
            cicadasSpawned++;
            imageCount++; 
            }  

        function updateArray(imageID){
            // keep track of images currently on the screen with an array
            imageArray.push(imageID);    
        }

        function hideImage(){
            // Hide images at a random after a random interval
            var randomIndex = Math.floor(Math.random() * imageArray.length);  
            var hideImage = imageArray[randomIndex];
            imageArray.splice(randomIndex, 1);  
            $(`#${hideImage}`).hide();
            cicadasMissed++;
        }
        
        function displayGameStats() {
            // Calculate statistics
            var accuracy = totalClicks > 0 ? ((successfulClicks / totalClicks) * 100).toFixed(1) : 0;
            var catchRate = cicadasSpawned > 0 ? ((successfulClicks / cicadasSpawned) * 100).toFixed(1) : 0;
            var avgReactionTime = clickTimes.length > 0 ? (clickTimes.reduce((a, b) => a + b, 0) / clickTimes.length / 1000).toFixed(2) : 0;
            
            // Build stats HTML
            var statsHTML = `
                <h3>Game Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">Final Score:</span>
                        <span class="stat-value">${userScore}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Click Accuracy:</span>
                        <span class="stat-value">${accuracy}%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Cicadas Caught:</span>
                        <span class="stat-value">${successfulClicks} / ${cicadasSpawned}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Catch Rate:</span>
                        <span class="stat-value">${catchRate}%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Missed Clicks:</span>
                        <span class="stat-value">${missedClicks}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Avg Reaction Time:</span>
                        <span class="stat-value">${avgReactionTime}s</span>
                    </div>
                </div>
            `;
            
            // Store game in history
            saveGameHistory({
                date: new Date().toLocaleDateString(),
                score: userScore,
                accuracy: accuracy,
                catchRate: catchRate,
                avgReactionTime: avgReactionTime
            });
            
            // Display stats
            $("#gameStats").html(statsHTML);
            displayGameHistory();
        }
        
        function saveGameHistory(gameData) {
            var history = JSON.parse(localStorage.getItem('cicadaGameHistory') || '[]');
            history.push(gameData);
            // Keep only last 10 games
            if (history.length > 10) {
                history = history.slice(-10);
            }
            localStorage.setItem('cicadaGameHistory', JSON.stringify(history));
        }
        
        function displayGameHistory() {
            var history = JSON.parse(localStorage.getItem('cicadaGameHistory') || '[]');
            if (history.length === 0) {
                $("#gameHistory").html('<p>No previous games yet. Play more to track your progress!</p>');
                return;
            }
            
            var historyHTML = '<h3>Recent Performance</h3><div class="history-list">';
            history.slice().reverse().forEach(function(game, index) {
                historyHTML += `
                    <div class="history-item">
                        <span class="history-date">${game.date}</span>
                        <span class="history-score">Score: ${game.score}</span>
                        <span class="history-accuracy">Accuracy: ${game.accuracy}%</span>
                    </div>
                `;
            });
            historyHTML += '</div>';
            $("#gameHistory").html(historyHTML);
        }

        // Modal handlers
        function gameOver() {
            $("#gameOverDialog").show();
        }

        $("#playAgainBtn").click(function() {
            $("#gameOverDialog").hide();
            startGame();
        });
        
        $("#exitBtn").click(function() {
            $("#gameOverDialog").hide();
        });

        $(window).click(function(event) {
            if ($(event.target).is("#gameOverDialog")) {
                $("#gameOverDialog").hide();
            }
        });

      </script>
    </head>

  <body>
   
	<div id="content">

        <h1>Cicada Smash!</h1>
	    <div id="instructions"  >
             <p > The cicadas are swarming! After clicking "start", you will have 30 seconds to click and destroy as many as you can. The images appear randomly so be ready!</p>
        </div>
                     
        <div id="controls">
            <span class = "score" title ="Your score">0 pts</span>
            <button type="button" id="start_button" title = "Click to start">Start!</button>
        </div>
       
        <div class="timer" title="Seconds remaining">
            30 sec left
        </div>
    	
        <div id="gamespace">
            <!-- Game Over Modal with Statistics -->
            <div id="gameOverDialog" class="custom-modal">
                <div class="modal-content">
                    <h2>Game Over!</h2>
                    <p>You scored <span class="score">0 pts</span></p>
                    
                    <div id="gameStats"></div>
                    
                    <div id="gameHistory"></div>
                    
                    <button class="close-button" id="playAgainBtn">Play Again</button>
                    <button class="exit-button" id="exitBtn">Exit</button>
                </div>
            </div>
		</div>

        <div id="sound">
            To turn off cicada sound, click below after game starts. <br>
            <audio id="playSounds" autoplay controls>
                <source src="audio/163688__cognito-perceptu__cicadas.wav" type="audio/wav" loop>
            </audio>
        </div>

    </div>
</body>
</html>